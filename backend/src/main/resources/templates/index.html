<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Personal Scouter - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 1200px; margin-top: 30px; }
        .error-message { color: #dc3545; font-weight: bold; }
        th { background-color: #f8f9fa; text-align: center; vertical-align: middle; }
        td { text-align: center; vertical-align: middle; }
        .prediction-panel { border: 1px solid #cce5ff; background-color: #f0f7ff; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
        .success-message { color: #0f5132; background-color: #d1e7dd; border-color: #badbcc; padding: 12px; margin-bottom: 15px; border-radius: 6px; }
        .animate-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <header class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ“Š ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã‚¹ã‚³ã‚¢ç…§ä¼š</h2>
            <a th:href="@{/input}" class="btn btn-primary">â• ã‚¹ã‚³ã‚¢å…¥åŠ›</a>
        </header>
        
        <form th:action="@{/search}" th:object="${searchForm}" method="get" class="p-3 mb-4 border rounded bg-light">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="startDate" class="form-label">é–‹å§‹æ—¥</label>
                    <input type="date" class="form-control" id="startDate" th:field="*{startDate}">
                </div>
                <div class="col-md-4">
                    <label for="endDate" class="form-label">çµ‚äº†æ—¥</label>
                    <input type="date" class="form-control" id="endDate" th:field="*{endDate}">
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-outline-primary w-100">ğŸ” ç…§ä¼šå®Ÿè¡Œ</button>
                </div>
            </div>
        </form>

        <div class="prediction-panel shadow-sm">
            <h4 class="mb-3">ğŸ“ˆ æœªæ¥äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ä½œæˆ (AIé€£æº)</h4>
            <div th:if="${message}" th:text="${message}" class="success-message"></div>
            
            <form th:action="@{/batch/run}" method="post">
                <div class="d-flex align-items-center gap-3">
                    <p class="mb-0 text-muted">Kafkaã‚’ä»‹ã—ã¦Pythonã‚¨ãƒ³ã‚¸ãƒ³ã«äºˆæ¸¬ã‚’ä¾é ¼ã—ã¾ã™ã€‚</p>
                    <button type="submit" id="predict-button" class="btn btn-warning">ğŸš€ äºˆæ¸¬ã‚¨ãƒ³ã‚¸ãƒ³èµ·å‹•</button>
                </div>
            </form>
            
            <div th:if="${predictions != null and !predictions.empty}" class="mt-4">
                <hr>
                <h5 class="text-primary mb-3">ğŸ¤– AIã«ã‚ˆã‚‹æ¥é€±ã®ä½“èª¿äºˆæ¸¬ (DBä¿å­˜æ¸ˆã¿)</h5>
                <table class="table table-sm table-bordered table-hover bg-white">
                    <thead class="table-primary">
                        <tr>
                            <th>äºˆæ¸¬æ—¥</th>
                            <th>äºˆæ¸¬ã‚¹ã‚³ã‚¢ (1-7)</th>
                            <th>åˆ¤å®š</th>
                        </tr>
                    </thead>
                    <tbody> 
                        <tr th:each="pred : ${predictions}">
                            <td th:text="${pred.targetDate}"></td> 
                            <td th:text="${#numbers.formatDecimal(pred.predictedScore, 1, 2)}" class="fw-bold"></td>
                            <td>
                                <span th:if="${pred.predictedScore >= 6.0}" class="badge bg-success">çµ¶å¥½èª¿</span>
                                <span th:if="${pred.predictedScore >= 5.0 and pred.predictedScore < 6.0}" class="badge bg-success">å¥½èª¿</span>
                                <span th:if="${pred.predictedScore >= 3.0 and pred.predictedScore < 5.0}" class="badge bg-warning text-dark">æ™®é€š</span>
                                <span th:if="${pred.predictedScore < 3.0}" class="badge bg-danger">ä¸èª¿è­¦æˆ’</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div th:if="${scores != null and !scores.empty}" class="mt-4">
            <h4 class="mb-3">æ¤œç´¢çµæœ (<span th:text="${#lists.size(scores)}"></span> ä»¶)</h4>
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover">
                    <thead>
                        <tr>
                            <th rowspan="2">æ—¥ä»˜</th>
                            <th colspan="8">å€‹åˆ¥ã‚¹ã‚³ã‚¢ (1-7)</th>
                            <th colspan="2" rowspan="2">ç·åˆè©•ä¾¡</th>
                        </tr>
                        <tr>
                            <th>é›†ä¸­</th><th>åŠ¹ç‡</th><th>æ„æ¬²</th><th>ä½“èª¿</th>
                            <th>è¦å¾‹</th> 
                            <th>ç–²åŠ´</th><th>ç¡çœ </th><th>æ€§æ¬²</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="score : ${scores}">
                            <td th:text="${score.date}"></td>
                            <td th:text="${score.focusScore}"></td>
                            <td th:text="${score.efficiencyScore}"></td>
                            <td th:text="${score.motivationScore}"></td>
                            <td th:text="${score.conditionScore}"></td>
                            <td th:text="${score.disciplineScore}"></td> 
                            <td th:text="${score.fatigueScore}"></td>
                            <td th:text="${score.sleepScore}"></td>
                            <td th:text="${score.sexualDesireScore}"></td>
                            <td th:text="${#numbers.formatDecimal(score.avgScore, 1, 2)}" class="fw-bold"></td>
                            <td>
                                <div th:text="${score.overallEvaluation}"></div>
                                <div th:if="${score.sexualDesireScore == 7}" class="mt-1">
                                    <span class="badge bg-danger p-2 shadow-sm animate-pulse">âš ï¸ CRITICAL: OVERHEAT</span>
                                    <div class="text-danger small fw-bold mt-1" style="font-size: 0.75rem; line-height: 1.2;">
                                        â˜…ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒªãƒ“ãƒ‰ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼<br>ç”Ÿå‘½åŠ›éå‰°ç‡ƒç„¼ / å³åˆ»ä¼‘æ¯ã‚’æ¨å¥¨
                                    </div>
                                </div>
                                <div th:if="${score.sexualDesireScore == 1}" class="mt-1">
                                    <span class="badge bg-primary p-2 shadow-sm">ğŸ§˜ SAGE MODE</span>
                                    <div class="text-primary small fw-bold mt-1" style="font-size: 0.75rem; line-height: 1.2;">
                                        â˜…è³¢è€…ãƒ¢ãƒ¼ãƒ‰ï¼<br>ã‚·ã‚¹ãƒ†ãƒ å®‰å®š / å›å¾©å„ªå…ˆçŠ¶æ…‹
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div th:if="${scores != null and scores.empty}" class="alert alert-light border text-center mt-4">
            <p class="mb-0 text-secondary">è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ¡ä»¶ã‚’å¤‰ãˆã¦æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚</p>
        </div>
    </div>

    <!-- index.html ã®äºˆæ¸¬çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã« ID ã‚’ä»˜ä¸ -->
    <div id="prediction-results-container">
        <!-- ã“ã“ã«ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
    </div>

    <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const button = document.getElementById('predict-button');
        const message = document.querySelector('.success-message');
        if (message && button) {
             button.disabled = false;
             button.textContent = 'ğŸš€ äºˆæ¸¬ã‚¨ãƒ³ã‚¸ãƒ³èµ·å‹•';
        }
    });

    function startPolling() {
        console.log("ğŸ”„ ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹...");
        
        const intervalId = setInterval(async () => {
            try {
                const response = await fetch('/api/predictions');
                const data = await response.json();
                
                // ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã‹ã‚‰å¢—ãˆãŸï¼ˆï¼Pythonã®çµæœãŒå±Šã„ã¦DBã«ä¿å­˜ã•ã‚ŒãŸï¼‰ã‹ãƒã‚§ãƒƒã‚¯
                if (data && data.length > 0) {
                    console.log("âœ… ãƒ‡ãƒ¼ã‚¿å—ä¿¡ï¼ç”»é¢ã‚’æ›´æ–°ã—ã¾ã™ã€‚");
                    clearInterval(intervalId);
                    location.reload(); // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°çŠ¶æ…‹ã‚’è¡¨ç¤º
                }
            } catch (error) {
                console.error("Polling error:", error);
            }
        }, 2000); // 2ç§’ãŠã
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
    document.querySelector('form[action="/batch/run"]').onsubmit = function(e) {
        e.preventDefault(); // é€šå¸¸ã®ç”»é¢é·ç§»ã‚’æ­¢ã‚ã‚‹
        
        const button = document.getElementById('predict-button');
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ğŸ§  AIè§£æä¸­...';
        
        // éåŒæœŸã§äºˆæ¸¬ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        fetch(this.action, { 
            method: 'POST',
            // Spring Securityã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        }).then(response => {
            console.log("ğŸš€ äºˆæ¸¬ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å®Œäº†ã€‚çµæœã‚’å¾…æ©Ÿã—ã¾ã™ã€‚");
            startPolling(); // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
        }).catch(error => {
            console.error("Request error:", error);
            button.disabled = false;
            button.innerHTML = 'ğŸš€ äºˆæ¸¬ã‚¨ãƒ³ã‚¸ãƒ³èµ·å‹•';
        });

        return false;
    };
    </script>
</body>
</html>