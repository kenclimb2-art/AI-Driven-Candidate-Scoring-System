<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Personal Scouter - ç…§ä¼šç”»é¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 1200px; margin-top: 30px; }
        .error-message { color: red; font-weight: bold; }
        th { background-color: #f8f9fa; text-align: center;}
        td { text-align: center; }
        .prediction-panel { border: 1px solid #cce5ff; background-color: #eaf5ff; padding: 20px; margin-bottom: 20px; border-radius: 5px; }
        .success-message { color: #0f5132; background-color: #d1e7dd; border-color: #badbcc; padding: 10px; margin-bottom: 15px; border-radius: 4px; }
        /* SSEé–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯ä¸è¦ã ãŒæ®‹ã™ */
        .realtime-message { color: #004085; background-color: #cce5ff; border-color: #b8daff; padding: 10px; margin-bottom: 15px; border-radius: 4px; transition: opacity 0.5s; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="mb-4">ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã‚¹ã‚³ã‚¢ç…§ä¼š</h2>
        
        <a th:href="@{/input}" class="btn btn-info mb-3">ã‚¹ã‚³ã‚¢å…¥åŠ›ã¸</a>

        <form th:action="@{/search}" action="/search" th:object="${searchForm}" method="get" class="p-3 mb-4 border rounded">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="startDate" class="form-label">é–‹å§‹æ—¥</label>
                    <input type="date" class="form-control" id="startDate" th:field="*{startDate}">
                    <span th:if="${#fields.hasErrors('startDate')}" th:errors="*{startDate}" class="error-message"></span>
                </div>
                
                <div class="col-md-4">
                    <label for="endDate" class="form-label">çµ‚äº†æ—¥</label>
                    <input type="date" class="form-control" id="endDate" th:field="*{endDate}">
                    <span th:if="${#fields.hasErrors('endDate')}" th:errors="*{endDate}" class="error-message"></span>
                </div>
                
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">ç…§ä¼šå®Ÿè¡Œ</button>
                </div>
            </div>
        </form>

        <div class="prediction-panel">
            <h4 class="mb-3">ğŸ“ˆ æœªæ¥äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ä½œæˆ (Pythoné€£æº)</h4>
            
            <div th:if="${message}" th:text="${message}" class="success-message"></div>
            
            <form th:action="@{/batch/run}" method="post" 
                  onsubmit="document.getElementById('predict-button').disabled = true; 
                            document.getElementById('predict-button').textContent = 'å‡¦ç†ä¸­...'; 
                            return true;" 
                  class="row g-3 align-items-center">
                <div class="col-auto">
                    <p class="mb-0">Kafkaã‚’çµŒç”±ã—ã¦ã€AIã‚¨ãƒ³ã‚¸ãƒ³(Python)ã«äºˆæ¸¬ã‚’ä¾é ¼ã—ã¾ã™ã€‚</p>
                </div>
                <div class="col-auto">
                    <button type="submit" id="predict-button" class="btn btn-warning">ğŸš€ äºˆæ¸¬ã‚¨ãƒ³ã‚¸ãƒ³èµ·å‹• (Kafkaé€£æº)</button>
                </div>
            </form>
            
            <div th:if="${predictions != null and !predictions.empty}" class="mt-4" id="prediction-results-area">
                <hr>
                <h5 class="text-primary">ğŸ¤– AIã«ã‚ˆã‚‹æ¥é€±ã®ä½“èª¿äºˆæ¸¬ (Linear Regression)</h5>
                
                <table class="table table-sm table-bordered table-hover" style="background-color: white;">
                    <thead class="table-primary">
                        <tr>
                            <th class="text-center">äºˆæ¸¬æ—¥</th>
                            <th class="text-center">äºˆæ¸¬ä½“èª¿ã‚¹ã‚³ã‚¢ (1-7)</th>
                            <th class="text-center">åˆ¤å®š</th>
                        </tr>
                    </thead>
                    <tbody> 
                        <tr th:each="pred : ${predictions}">
                            <td class="text-center" th:text="${pred.date}"></td> 
                            <td class="text-center" th:text="${#numbers.formatDecimal(pred.predictedScore, 1, 2)}" style="font-weight: bold;"></td>
                            <td class="text-center" th:with="score=${pred.predictedScore}">
                                <span th:if="${score >= 6.0}" class="badge bg-success">çµ¶å¥½èª¿</span>
                                <span th:if="${score >= 5.0 and score < 6.0}" class="badge bg-success">å¥½èª¿</span>
                                <span th:if="${score >= 3.0 and score < 5.0}" class="badge bg-warning text-dark">æ™®é€š</span>
                                <span th:if="${score < 3.0}" class="badge bg-danger">ä¸èª¿è­¦æˆ’</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div th:if="${predictions == null or predictions.empty}" class="mt-4" id="no-predictions-area">
                <hr class="mt-3 mb-3"/>
                <h5>é€£æºã«ã¤ã„ã¦</h5>
                <ol style="font-size: 0.9em;">
                    <li>ä¸Šè¨˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€Kafkaãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã€Pythonäºˆæ¸¬ã‚¨ãƒ³ã‚¸ãƒ³ã‚’èµ·å‹•ã—ã¾ã™ã€‚</li>
                    <li>çµæœã¯éåŒæœŸã§å‡¦ç†ã•ã‚Œã¾ã™ãŒã€**ç”»é¢ã¯ãƒªãƒ­ãƒ¼ãƒ‰å¾Œã«æ›´æ–°ã•ã‚Œã¾ã™**ã€‚</li>
                </ol>
            </div>
        </div>

        <div th:if="${scores != null and !scores.empty}" class="mt-4">
            <h4 class="mb-3">æ¤œç´¢çµæœ (<span th:text="${#lists.size(scores)}"></span> ä»¶)</h4>
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th rowspan="2" style="vertical-align: middle;">æ—¥ä»˜</th>
                        <th colspan="7" class="text-center">å€‹åˆ¥ã‚¹ã‚³ã‚¢ (1-7)</th>
                        <th colspan="2" rowspan="2" style="vertical-align: middle;">ç·åˆè©•ä¾¡</th>
                    </tr>
                    <tr>
                        <th>é›†ä¸­åŠ›</th><th>åŠ¹ç‡</th><th>ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³</th><th>ä½“èª¿</th>
                        <th>ç–²åŠ´</th><th>ç¡çœ ã®è³ª</th><th>æ€§æ¬²</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="score : ${scores}">
                        <td th:text="${score.date}"></td> <td th:text="${score.focusScore}"></td> 
                        <td th:text="${score.efficiencyScore}"></td>
                        <td th:text="${score.motivationScore}"></td>
                        <td th:text="${score.conditionScore}"></td>
                        <td th:text="${score.fatigueScore}"></td>
                        <td th:text="${score.sleepScore}"></td>
                        <td th:text="${score.sexualDesireScore}"></td>
                        
                        <td th:text="${#numbers.formatDecimal(score.avgScore, 1, 2)}"></td>
                        <td th:text="${score.overallEvaluation}"></td>

                    </tr>
                </tbody>
            </table>
        </div>
        
        <div th:if="${(scores == null or scores.empty) and (searchForm == null or #lists.isEmpty(#fields.allErrors()))}" class="mt-4">
             <p class="text-secondary">æ¤œç´¢æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦ç…§ä¼šã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
        </div>
    </div>
    
    <script>
    /* äºˆæ¸¬å®Ÿè¡Œå¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã§æˆ»ã£ã¦ããŸéš›ã€ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™ãŸã‚ã®JS */
    document.addEventListener('DOMContentLoaded', function() {
        const button = document.getElementById('predict-button');
        const message = document.querySelector('.success-message');
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆï¼äºˆæ¸¬ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ãŸå¾Œï¼‰
        if (message && button) {
             // äºˆæ¸¬çµæœã‚’å¾…ã¤é–“ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ãŸã‚ã€
             // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã—ã¦å†åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹
             button.disabled = false;
             button.textContent = 'ğŸš€ äºˆæ¸¬ã‚¨ãƒ³ã‚¸ãƒ³èµ·å‹• (Kafkaé€£æº)';
        }
    });
    </script>
</body>
</html>